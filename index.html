<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø¨Ø§Ø²ÛŒ Ù¾Ù†Ù„ - iswitch</title>
  <style>
    /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ù…Ù„ */
    @font-face {
      font-family: 'Digital7';
      src: url('assets/digital-7.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }

    :root {
      --bg: #071025;
      --panel-w: 1808px;
      --panel-h: 592px;
      --led-size: 50px;
      --accent: #00ff9d;
      --error-color: #fa0536;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      background: linear-gradient(180deg, #051020, #071025 40%);
      font-family: "Vazirmatn", "Tahoma", sans-serif;
      color: #e6eef6;
      padding: 24px;
      overflow-x: auto;
    }

    /* Ù¾Ù†Ù„ Ø§ØµÙ„ÛŒ */
    .panel-wrap {
      position: relative;
      width: var(--panel-w);
      height: var(--panel-h);
      background: transparent;
    }

    /* Ø¹Ú©Ø³ Ù¾Ø³ Ø²Ù…ÛŒÙ†Ù‡ */
    .panel-bg {
      width: 100%;
      height: 100%;
      display: block;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
    }

    /* Ù‡Ù…Ù‡ Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§ Ø±ÙˆÛŒ Ø¹Ú©Ø³ */
    .mushroom, .push-btn, .selector, .joystick, .fan-wrap, 
    .led, .protector-area, .game-timer, .stages, 
    .map-small, .error-badge, .win-light {
      position: absolute;
      z-index: 2;
    }

    /* LED Ù‡Ø§ */
    .led {
      width: var(--led-size);
      height: var(--led-size);
      border-radius: 50%;
      box-shadow: 0 0 0 rgba(0,0,0,0.0);
      opacity: 0.35;
      transition: all .18s ease;
      pointer-events: none;
    }
    .led[data-state="on"] { 
      opacity: 1; 
      filter: drop-shadow(0 0 10px rgba(255,255,255,0.15)); 
    }

   /* LED Ù‡Ø§ÛŒ Ù¾Ø±Ø±Ù†Ú¯â€ŒØªØ± */
.led-red { 
    background: radial-gradient(circle at 30% 30%, #f72c2c, #ff0000); /* Ù‚Ø±Ù…Ø² Ù¾Ø±Ø±Ù†Ú¯ */
    left: 1274px; top: 138px; z-index: 3;
}
.led-yellow { 
    background: radial-gradient(circle at 30% 30%, #ffd93d, #ff9f00); /* Ø²Ø±Ø¯ Ù¾Ø±Ø±Ù†Ú¯ */
    left:1274px; top: 45px; z-index: 2;
}
.led-green { 
    background: radial-gradient(circle at 30% 30%, #6bff6b, #00ff00); /* Ø³Ø¨Ø² Ù¾Ø±Ø±Ù†Ú¯ */
    left: 1274px; top: 138px; z-index: 3;
}

/* ÙˆÙ‚ØªÛŒ Ø±ÙˆØ´Ù† Ù‡Ø³ØªÙ†Ø¯ Ø¯Ø±Ø®Ø´Ø´ Ø¨ÛŒØ´ØªØ± */
.led[data-state="on"] { 
    opacity: 1; 
    filter: drop-shadow(0 0 15px currentColor) brightness(1.3);
}

    /* Ù¾ÙˆØ´ Ø¨Ø§ØªÙ† Ù‡Ø§ */
    .push-btn {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      border: none;
      background: #d9534f;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      transition: transform .06s ease, box-shadow .06s ease;
      box-shadow: 0 8px 0 rgba(0,0,0,0.4);
    }

    /* Ù…ÙˆÙ‚Ø¹ÛŒØª Ù¾ÙˆØ´ Ø¨Ø§ØªÙ† Ù‡Ø§ */
    #S1 {left: 1448px; top: 142px; background: #00000000; }
    #S4_START { left: 1056px; top: 186px; background: #00000000; }
    #S4_STOP { left: 1056px; top: 240px; background: #ef444400; }
    #S6_START { left: 1170px; top: 164px; background: #00000000; }
    #S6_STOP { left: 1170px; top: 240px; background: #00000000; }
    #S7 { left: 1626px;top: 357.3px; background: #00000000; }
    #S8 { left: 1626px;top: 238.3px; background: #00000000; }
    #S10 { left: 1626px;top: 140px;background: #39796400;}

    /* ÙØ´Ø§Ø± Ø¯Ø§Ø¯Ù† */
    .push-btn[aria-pressed="true"] {
      transform: translateY(6px);
      box-shadow: 0 2px 0 rgba(0,0,0,0.6);
    }
    .push-btn[aria-pressed="true"]::after {
      content: '';
      position: absolute;
      inset: -8px;
      border-radius: 12px;
      box-shadow: 0 0 5px rgba(255,255,255,0.08);
    }

    /* Ø³Ù„Ú©ØªÙˆØ±Ù‡Ø§ */
    .selector {
      width: 48px;
      height: 28px;
      border-radius: 6px;
      background: rgba(0,0,0,0.5);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform .08s ease;
      user-select: none;
    }
    .selector[data-pos="left"] { transform: rotate(310deg); }
    .selector[data-pos="right"] { transform: rotate(18deg); }

    /* Ù…ÙˆÙ‚Ø¹ÛŒØª Ø³Ù„Ú©ØªÙˆØ±Ù‡Ø§ */
    #S2 { 
    left: 1450px; top: 241.3px; }
    #S3 { left: 1274px; top: 244px; }
    #S5 { left: 1450px; top: 366px; }

    /* Ø¬ÙˆÛŒ Ø§Ø³ØªÛŒÚ© */
    .joystick {
      left: 1666px;
      top: 34px;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #111827;
      border: none;
      color: #fff;
      cursor: pointer;
      transition: transform .12s ease;
    }
    .joystick[data-pos="down"] { transform: translateY(10px) rotate(6deg); }

    /* Ù…Ø­Ø§ÙØ¸ - Ù†Ù…Ø§ÛŒØ´ Ø¹Ø¯Ø¯ 300 */
    .protector-area {
    left: 23.3%;
    top: 45.4%;
    width: 60px;
    height: 60px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.7);
    border-radius: 8px;
    border: 0px solid #ff3b30;
}

    .protector-display {
      font-family: 'Digital7', monospace;
      font-size: 28px;
      color: #ff3b30;
      text-shadow: 0 0 10px rgba(255, 59, 48, 0.5);
    }

    /* ÙÙ† Ù‡Ø§ */
    .fan-wrap {
      width: 175px;
      height: 175px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .fan-base { 
      position: absolute; 
      width: 100%; 
      height: 100%; 
      object-fit: contain; 
    }
    .fan-blade {
      position: absolute; 
      width: 70%;
      height: 70%;
      object-fit: contain; 
      transform-origin: center center;
      transition: opacity .16s ease;
      opacity: 0;
    }

    /* Ù…ÙˆÙ‚Ø¹ÛŒØª ÙÙ† Ù‡Ø§ */
    #fanBlue { left: 52%; top: 59.7%; }
    #fanYellow { left: 66.1%; top: 59.7%; }

    /* blade rotating class */
    .rotate-medium {
      animation: spin 0.7s linear infinite;
      opacity: 1;
    }
    @keyframes spin { 
      from { transform: rotate(0deg); } 
      to { transform: rotate(360deg); } 
    }

    /* Ø¯Ú©Ù…Ù‡ Ù‚Ø§Ø±Ú†ÛŒ */
    .mushroom {
      width: 50px;
      height: 50px;
      left: 1450px;
      top: 40px;
      background: transparent;
      border: none;
      cursor: pointer;
      border-radius: 26px;
    }

    /* ØªÛŒÚ© Ù…Ø±Ø§Ø­Ù„ */
    .stages {
      right:70%;
      top: 5%;
      display: flex;
      gap: 8px;
    }
    .stage {
      width: 26px;
      height: 26px;
      border-radius: 6px;
      background: rgba(255,255,255,0.06);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #a8c0d8;
      font-size: 13px;
    }
    .stage.done { 
      background: linear-gradient(90deg, #34d399, #10b981); 
      color: #042018; 
      box-shadow: 0 6px 16px rgba(16,185,129,0.12); 
    }

    /* ØªØ§ÛŒÙ…Ø± Ú©Ù„ÛŒ Ø¨Ø§Ø²ÛŒ */
    .game-timer {
      left: 5%;
      top: 5%;
      background: rgba(0,0,0,0.6);
      padding: 8px 12px;
      border-radius: 8px;
      font-family: 'Digital7', monospace;
      font-size: 22px;
      color: #ffd166;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }

      /* Ù†Ù‚Ø´Ù‡ */
    .map-small {
      left: 5%;
      bottom: 5%;
      width: 80px;
      height: 60px;
      border-radius: 6px;
      cursor: pointer;
      border: 2px solid rgba(255,255,255,0.1);
      overflow: hidden;
    }
    .map-thumbnail {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Ø®Ø·Ø§ÛŒ Ú©ÙˆÚ†Ú© */
    .error-badge {
      right: 5%;
      bottom: 5%;
      background: var(--error-color);
      color: #fff;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      opacity: 0;
      transform: translateY(8px);
      transition: all .28s ease;
    }
    .error-badge.show { 
      opacity: 1; 
      transform: translateY(0); 
    }

    /* Ú†Ø±Ø§Øº Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ø¯Ù† */
  .win-light {
    left: 50%;
    top: 5%;
    width: 400px;
    height: 120px; /* Ø¨Ø²Ø±Ú¯ØªØ± */
    border-radius: 8px;
    background: transparent; /* Ø¨Ø¯ÙˆÙ† ÙÛŒÙ„ */
    border: 3px solid rgba(255,255,255,0.1); /* Ø§Ø³ØªØ±ÙˆÚ© */
    box-shadow: none;
    transition: all .3s ease;
    transform: translateX(-50%);
}
    .win-light2 {
    left: 50%;
    top: 8%;
    width: 60px;  /* Ø¨Ø²Ø±Ú¯ØªØ± */
    height: 30px; /* Ø¨Ø²Ø±Ú¯ØªØ± */
    border-radius: 8px;
    background: transparent; /* Ø¨Ø¯ÙˆÙ† ÙÛŒÙ„ */
    border: 3px solid rgba(255,255,255,0.1); /* Ø§Ø³ØªØ±ÙˆÚ© */
    box-shadow: none;
    transition: all .3s ease;
    transform: translateX(-50%);
}
.win-light.on { 
    background: transparent; /* Ù‡Ù…Ú†Ù†Ø§Ù† Ø¨Ø¯ÙˆÙ† ÙÛŒÙ„ */
    border:3px solid #ffbbb7; /* Ø§Ø³ØªØ±ÙˆÚ© Ù†Ø§Ø±Ù†Ø¬ÛŒ */
    box-shadow: 
        0 0 20px rgba(249,115,22,0.8),    /* Ú¯Ù„ÙˆÛŒ Ø¯Ø§Ø®Ù„ÛŒ */
        0 0 40px rgba(249,115,22,0.4),    /* Ú¯Ù„ÙˆÛŒ Ø¨ÛŒØ±ÙˆÙ†ÛŒ */
        inset 0 0 15px rgba(249,115,22,0.3); /* Ú¯Ù„ÙˆÛŒ Ø¯Ø§Ø®Ù„ÛŒ */
    animation: pulse 1.5s ease-in-out infinite alternate;
}

@keyframes pulse {
    from {
        box-shadow: 
            0 0 15px rgba(249,115,22,0.6),
            0 0 30px rgba(249,115,22,0.3),
            inset 0 0 10px rgba(249,115,22,0.2);
    }
    to {
        box-shadow: 
            0 0 25px rgba(249,115,22,1),
            0 0 50px rgba(249,115,22,0.6),
            inset 0 0 20px rgba(249,115,22,0.4);
    }
}


.buzzer-light {
    position: absolute;
    left: 970px;
    top: 260px;
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: #ff0000;
    transform: translateX(-50%);
    opacity: 0;
    box-shadow: 0 0 0 rgba(255,0,0,0);
    transition: all 0.3s ease;
    z-index: 1000;
}

/* Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ú†Ø´Ù…Ú© Ø²Ù† */
.buzzer-light.blinking {
    opacity: 1;
    animation: blink 0.5s ease-in-out infinite alternate;
}

@keyframes blink {
    0% {
        background: #ff0000;
        box-shadow: 0 0 30px rgba(255,0,0,0.9);
        transform: translateX(-50%) scale(1);
    }
    100% {
        background: #ff6b6b;
        box-shadow: 0 0 60px rgba(255,0,0,1);
        transform: translateX(-50%) scale(1.2);
    }

}
    /* Ù…ÙˆØ¯Ø§Ù„ Ù…Ø­Ø§ÙØ¸ */
    .modal { 
      position: fixed; 
      inset: 0; 
      display: none; 
      align-items: center; 
      justify-content: center; 
      z-index: 50; 
    }
    .modal.open { 
      display: flex; 
    }
    .modal-backdrop { 
      position: absolute; 
      inset: 0; 
      background: rgba(0,0,0,0.5); 
    }
    .modal-box { 
      position: relative; 
      z-index: 60; 
      background: #0b1220; 
      padding: 18px; 
      border-radius: 12px; 
      min-width: 260px; 
      color: #fff; 
      box-shadow: 0 18px 50px rgba(0,0,0,0.6); 
      transform: scale(.8); 
      transition: transform .28s ease; 
    }
    .modal.open .modal-box { 
      transform: scale(1); 
    }

    /* protector UI */
    .protector-ui { 
      display: flex; 
      flex-direction: column; 
      gap: 12px; 
      align-items: center; 
    }
    .protector-title { 
      font-size: 20px; 
      font-weight: 900; 
      color: #9fd5ff; 
    }
    .protector-value { 
      font-family: 'Digital7'; 
      font-size: 38px; 
      background: #000; 
      padding: 6px 12px; 
      border-radius: 8px; 
      color: #00ff80; 
      transition: all 0.1s ease;
    }
    .protector-value.changing {
      color: #ffd166;
      transform: scale(1.05);
    }
    .protector-controls { 
      display: flex; 
      gap: 8px; 
    }
    .ctrl { 
      padding: 8px 12px; 
      border-radius: 8px; 
      border: none; 
      background: #111827; 
      color: #fff; 
      cursor: pointer; 
      font-weight: 700; 
      transition: all 0.1s ease;
    }
    .ctrl:active {
      background: #1e40af !important;
      transform: scale(0.95);
    }
    .prot-close { 
      cursor: pointer; 
      color: #9fb1c9; 
      font-size: 13px; 
    }

    /* Ù…ÙˆØ¯Ø§Ù„ Ù†Ù‚Ø´Ù‡ */
    .map-box {
      max-width: 90vw;
      max-height: 90vh;
      overflow: auto;
    }
    .map-box img {
      width: 100%;
      height: auto;
      max-width: 800px;
    }
/* Ù…ÙˆØ¯Ø§Ù„ Ù†Ù‚Ø´Ù‡ */
.map-modal .modal-box {
  max-width: 95vw;
  max-height: 95vh;
  padding: 0;
  background: transparent;
  box-shadow: 0 25px 80px rgba(0,0,0,0.9);
  border: 3px solid rgba(255,255,255,0.1);
  border-radius: 12px;
  overflow: hidden;
}

.map-large {
  width: 100%;
  height: 100%;
  object-fit: contain;
  display: block;
}

/* Ø¯Ú©Ù…Ù‡ Ø¨Ø³ØªÙ† Ù†Ù‚Ø´Ù‡ */
.map-close {
  position: absolute;
  top: 10px;
  left: 10px;
  background: rgba(0,0,0,0.7);
  color: white;
  border: none;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 20px;
  z-index: 70;
  display: flex;
  align-items: center;
  justify-content: center;
}

.map-close:hover {
  background: rgba(0,0,0,0.9);
}
    /* responsive */
    @media (max-width: 1808px) {
      .panel-wrap {
        transform: scale(0.8);
        transform-origin: top center;
      }
    }

    /* Ù¾ÛŒØ§Ù… Ú†Ø±Ø®Ø´ Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ */
.rotate-message {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    color: white;
    z-index: 10000;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    text-align: center;
    font-family: "Vazirmatn", sans-serif;
}

.rotate-icon {
    font-size: 60px;
    margin-bottom: 20px;
    animation: bounce 2s infinite;
}

.rotate-text {
    font-size: 22px;
    margin-bottom: 10px;
    font-weight: bold;
}

.rotate-subtext {
    font-size: 16px;
    opacity: 0.8;
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
    }
    40% {
        transform: translateY(-10px);
    }
    60% {
        transform: translateY(-5px);
    }
}

/* ÙˆÙ‚ØªÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø¯Ø± Ø­Ø§Ù„Øª Ø§ÙÙ‚ÛŒ Ù‡Ø³ØªØŒ Ù¾ÛŒØ§Ù… Ø±Ùˆ Ù…Ø®ÙÛŒ Ú©Ù† */
@media (max-width: 768px) and (orientation: landscape) {
    .rotate-message {
        display: none !important;
    }
}

/* ÙˆÙ‚ØªÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø¯Ø± Ø­Ø§Ù„Øª Ø¹Ù…ÙˆØ¯ÛŒ Ù‡Ø³ØªØŒ Ù¾ÛŒØ§Ù… Ø±Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡ */
@media (max-width: 768px) and (orientation: portrait) {
    .rotate-message {
        display: flex;
    }
    
    /* Ø¨Ø§Ø²ÛŒ Ø±Ùˆ Ù…Ø®ÙÛŒ Ú©Ù† ÙˆÙ‚ØªÛŒ Ù¾ÛŒØ§Ù… Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒØ´Ù‡ */
    .game-root {
        display: none;
    }
}
  </style>
</head>











<body>
  <main class="game-root">
    <!-- Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ù¾Ù†Ù„ -->
    <div class="panel-wrap">
      <img src="assets/BOARD.png" alt="Ù¾Ù†Ù„" class="panel-bg" id="panelBg">

      <!-- Ù¾ÛŒØ§Ù… Ú†Ø±Ø®Ø´ Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ -->
     <div id="rotateMessage" class="rotate-message">
    <div class="rotate-icon">ğŸ“±</div>
    <div class="rotate-text">Ù„Ø·ÙØ§Ù‹ Ú¯ÙˆØ´ÛŒ Ø±Ø§ Ø§ÙÙ‚ÛŒ Ú©Ù†ÛŒØ¯</div>
    <div class="rotate-subtext">Ø¨Ø±Ø§ÛŒ ØªØ¬Ø±Ø¨Ù‡ Ø¨Ù‡ØªØ± Ø¨Ø§Ø²ÛŒ</div>
    </div>

      <!-- LED Ù‡Ø§ -->
      <div class="led led-red" id="LED3" data-state="off" aria-label="LED3 Ù‚Ø±Ù…Ø²"></div>
      <div class="led led-yellow" id="LED4" data-state="off" aria-label="LED4 Ø²Ø±Ø¯"></div>
      <div class="led led-green" id="LED1" data-state="off" aria-label="LED1 Ø³Ø¨Ø²"></div>
      <!-- Ú†Ø±Ø§Øº Ø¨ÛŒØ²Ø± -->
      <div class="buzzer-light" id="buzzerLight" aria-hidden="true"></div>
      <!-- Ù¾ÙˆØ´ Ø¨Ø§ØªÙ† Ù‡Ø§ -->
      <button id="S0" class="mushroom" aria-label="Ú©Ù„ÛŒØ¯ Ù‚Ø§Ø±Ú†ÛŒ Ø´Ø±ÙˆØ¹">S0</button>
      <button class="push-btn" id="S1" data-id="S1" aria-pressed="false" aria-label="Ú©Ù„ÛŒØ¯ S1">S1</button>
      <button class="push-btn" id="S4_START" data-id="S4_START" aria-pressed="false" aria-label="Ú©Ù„ÛŒØ¯ S4 Ø§Ø³ØªØ§Ø±Øª">S4 Start</button>
      <button class="push-btn" id="S6_START" data-id="S6_START" aria-pressed="false" aria-label="Ú©Ù„ÛŒØ¯ S6 Ø§Ø³ØªØ§Ø±Øª">S6 Start</button>
      <button class="push-btn" id="S4_STOP" data-id="S4_STOP" aria-pressed="false" aria-label="Ú©Ù„ÛŒØ¯ S4 Ø§Ø³ØªØ§Ù¾">S4 Stop</button>
      <button class="push-btn" id="S6_STOP" data-id="S6_STOP" aria-pressed="false" aria-label="Ú©Ù„ÛŒØ¯ S6 Ø§Ø³ØªØ§Ù¾">S6 Stop</button>
      <button class="push-btn" id="S7" data-id="S7" aria-pressed="false" aria-label="Ú©Ù„ÛŒØ¯ S7">S7</button>
      <button class="push-btn" id="S8" data-id="S8" aria-pressed="false" aria-label="Ú©Ù„ÛŒØ¯ S8">S8</button>
      <button class="push-btn" id="S10" data-id="S10" aria-pressed="false" aria-label="Ú©Ù„ÛŒØ¯ S10">S10</button>

      <!-- Ø³Ù„Ú©ØªÙˆØ±Ù‡Ø§ -->
      <div class="selector" id="S2" data-pos="left" role="switch" aria-checked="false" aria-label="Ø³Ù„Ú©ØªÙˆØ± S2">S2</div>
      <div class="selector" id="S3" data-pos="left" role="switch" aria-checked="false" aria-label="Ø³Ù„Ú©ØªÙˆØ± S3">S3</div>
      <div class="selector" id="S5" data-pos="left" role="switch" aria-checked="false" aria-label="Ø³Ù„Ú©ØªÙˆØ± S5">S5</div>

      <!-- Ø¬ÙˆÛŒâ€ŒØ§Ø³ØªÛŒÚ© -->
      <button class="joystick" id="S9" data-pos="neutral" aria-pressed="false" aria-label="Ø¬ÙˆÛŒ Ø§Ø³ØªÛŒÚ© S9">S9</button>

      <!-- Ù…Ø­Ø§ÙØ¸ Ø¨Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¹Ø¯Ø¯ 300 -->
      <div id="protectorArea" class="protector-area">
        <div class="protector-display" id="protectorDisplay">300</div>
      </div>

      <!-- ÙÙ† Ù‡Ø§ -->
      <div class="fan-wrap fan-blue" id="fanBlue">
        <!-- Ø§Ú¯Ø± Ø¹Ú©Ø³ ÙÙ† Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³ØªØŒ Ø§Ø² Ø¯Ø§ÛŒØ±Ù‡ Ø±Ù†Ú¯ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… -->
        <div class="fan-base" style="background: radial-gradient(circle at 30% 30%, #3b82f6, #1e40af); border-radius: 50%;"></div>
        <div class="fan-blade" id="fanBladeBlue" style="background: conic-gradient(#60a5fa, #93c5fd, #60a5fa); border-radius: 50%;"></div>
      </div>

      <div class="fan-wrap fan-yellow" id="fanYellow">
        <div class="fan-base" style="background: radial-gradient(circle at 30% 30%, #f59e0b, #d97706); border-radius: 50%;"></div>
        <div class="fan-blade" id="fanBladeYellow" style="background: conic-gradient(#fbbf24, #fcd34d, #fbbf24); border-radius: 50%;"></div>
      </div>

      <!-- ØªÛŒÚ© Ù…Ø±Ø§Ø­Ù„ -->
      <div class="stages" id="stages" aria-label="Ù…Ø±Ø§Ø­Ù„ Ø¨Ø§Ø²ÛŒ">
        <div class="stage" data-stage="1">1</div>
        <div class="stage" data-stage="2">2</div>
        <div class="stage" data-stage="3">3</div>
        <div class="stage" data-stage="4">4</div>
        <div class="stage" data-stage="5">5</div>
        <div class="stage" data-stage="6">6</div>
        <div class="stage" data-stage="7">7</div>
      </div>

      <!-- ØªØ§ÛŒÙ…Ø± Ø¨Ø§Ø²ÛŒ -->
      <div class="game-timer" id="gameTimer" aria-label="Ø²Ù…Ø§Ù† Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡">02:30</div>

 <img src="assets/map_small.png" id="mapSmall" class="map-small" alt="Ù†Ù‚Ø´Ù‡">

<!-- Ù…ÙˆØ¯Ø§Ù„ Ù†Ù‚Ø´Ù‡ -->
<div class="modal map-modal" id="mapModal" aria-hidden="true">
    <div class="modal-backdrop" id="mapBackdrop"></div>
    <div class="modal-box map-box">
        <img src="assets/map_large.jpg" alt="Ù†Ù‚Ø´Ù‡ Ø¨Ø²Ø±Ú¯ Ø¨Ø§Ø²ÛŒ" class="map-large">
    </div>
</div>
      <!-- Ø®Ø·Ø§ -->
      <div class="error-badge" id="errorBadge" aria-hidden="true">âœ–</div>

      <!-- Ú†Ø±Ø§Øº Ø¨Ø±Ù†Ø¯Ù‡ -->
       <div clas="win-light20"></div>
      <div class="win-light" id="winLight" aria-hidden="true"></div>
    </div>
  </main>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ù…Ø­Ø§ÙØ¸ -->
  <div class="modal" id="protectorModal" aria-hidden="true">
    <div class="modal-backdrop" id="modalBackdrop"></div>
    <div class="modal-box" role="dialog" aria-modal="true" aria-label="ØªÙ†Ø¸ÛŒÙ… Ù…Ø­Ø§ÙØ¸">
      <div class="protector-ui">
        <div class="protector-title">TS</div>
        <div class="protector-value" id="protectorValue">S300</div>
        <div class="protector-controls">
          <button id="protUp" class="ctrl" aria-label="Ø§ÙØ²Ø§ÛŒØ´ Ø²Ù…Ø§Ù†">â–²</button>
          <button id="protSet" class="ctrl" aria-label="ØªÙ†Ø¸ÛŒÙ…">SET</button>
          <button id="protDown" class="ctrl" aria-label="Ú©Ø§Ù‡Ø´ Ø²Ù…Ø§Ù†">â–¼</button>
        </div>
        <div class="prot-close" id="protClose" role="button" tabindex="0">Ø¨Ø³ØªÙ†</div>
      </div>
    </div>
  </div>

 
      
      </div>
    </div>
  </div>






















  <script>

    /* app.js - Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù‡ Ø¯Ø± Ù‡Ù…Ø§Ù† Ù¾ÙˆØ´Ù‡ */
    /* ÙØ±Ø¶: ØªÙ…Ø§Ù…ÛŒ Ø¹Ú©Ø³â€ŒÙ‡Ø§ Ùˆ ÙÙˆÙ†Øªâ€ŒÙ‡Ø§ Ø¯Ø± assets/ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ù†Ø¯ */
    /* Ù…Ø³ÛŒØ± ØµØ¯Ø§Ù‡Ø§ */
    const assets = {
      click: 'assets/click.mp3',
      error: 'assets/error.mp3',
      ding: 'assets/ding.mp3',
      fan: 'assets/fan_loop.mp3'
   };

/* helper Ø¨Ø±Ø§ÛŒ ØµØ¯Ø§ (fail-safe Ø§Ú¯Ø± ÙØ§ÛŒÙ„ Ù†Ø¨Ø§Ø´Ø¯) */
function playSound(src, volume = 0.6, loop = false){
  try {
    const a = new Audio(src);
    a.volume = volume;
    a.loop = loop;
    a.play().catch(()=>{/* silent fail */});
    return a;
  } catch(e){}
}

    

    /* Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ú©Ø§Ù…Ù„ Ø¨Ø§Ø²ÛŒ */
    const state = {
      stage: 0,
      gameTimerSec: 150,
      protectorValue: 300, // Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡ Ù…Ø­Ø§ÙØ¸
      protectorActive: false,
      signals: { LED3: 'off', LED4: 'off', LED1: 'off' },
      selector: { S2: 'left', S3: 'left', S5: 'left' },
      pushes: {},
      joystick: 'neutral',
      fan: { blue: false, yellow: false },
      lastPressTimestamps: {},
      gameRunning: false,
      gameTimerInterval: null
    };

    // ØªØ´Ø®ÛŒØµ Ø­Ø§Ù„Øª Ù…ÙˆØ¨Ø§ÛŒÙ„ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ú†Ø±Ø®Ø´
function checkMobileOrientation() {
    const rotateMessage = document.getElementById('rotateMessage');
    const gameRoot = document.querySelector('.game-root');
    const isMobile = window.innerWidth <= 768;
    
    if (isMobile && window.innerHeight > window.innerWidth) {
        // Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø¯Ø± Ø­Ø§Ù„Øª Ø¹Ù…ÙˆØ¯ÛŒ - Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…
        rotateMessage.style.display = 'flex';
        if (gameRoot) gameRoot.style.display = 'none';
    } else {
        // Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø¯Ø± Ø­Ø§Ù„Øª Ø§ÙÙ‚ÛŒ ÛŒØ§ Ø¯Ø³Ú©ØªØ§Ù¾ - Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù…
        rotateMessage.style.display = 'none';
        if (gameRoot) gameRoot.style.display = 'block';
    }
}

// Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù Ø¨Ø±Ø§ÛŒ ØªØ´Ø®ÛŒØµ ØªØºÛŒÛŒØ± Ø­Ø§Ù„Øª
window.addEventListener('load', checkMobileOrientation);
window.addEventListener('resize', checkMobileOrientation);
window.addEventListener('orientationchange', function() {
    // ØªØ£Ø®ÛŒØ± Ú©ÙˆÚ†Ú© Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ orientationchange Ú©Ø§Ù…Ù„ Ø¨Ø´Ù‡
    setTimeout(checkMobileOrientation, 100);
});

// Ù‡Ù…Ú†Ù†ÛŒÙ† Ù‡Ø± 2 Ø«Ø§Ù†ÛŒÙ‡ Ú†Ú© Ú©Ù† (Ø¨Ø±Ø§ÛŒ Ø¨Ø¹Ø¶ÛŒ Ù…Ø±ÙˆØ±Ú¯Ø±Ù‡Ø§)
setInterval(checkMobileOrientation, 2000);

    /* query elements */
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);

    const LED3 = $('#LED3');
    const LED4 = $('#LED4');
    const LED1 = $('#LED1');
    const S0 = $('#S0');
    const protectorArea = $('#protectorArea');
    const protectorDisplay = $('#protectorDisplay');
    const protectorModal = $('#protectorModal');
    const protUp = $('#protUp');
    const protDown = $('#protDown');
    const protSet = $('#protSet');
    const protClose = $('#protClose');
    const protectorValueEl = $('#protectorValue');
    const gameTimerEl = $('#gameTimer');
    const errorBadge = $('#errorBadge');
    const stagesEls = document.querySelectorAll('.stage');
    const mapSmall = $('#mapSmall');
    const mapModal = $('#mapModal');
    const mapBackdrop = $('#mapBackdrop');
    const modalBackdrop = $('#modalBackdrop');
    const winLight = $('#winLight');
    const fanBladeBlue = $('#fanBladeBlue');
    const fanBladeYellow = $('#fanBladeYellow');

    /* Ø¢Ù¾Ø¯ÛŒØª Ù†Ù…Ø§ÛŒØ´ Ù…Ø­Ø§ÙØ¸ Ø±ÙˆÛŒ Ù¾Ù†Ù„ */
    function updateProtectorDisplayOnPanel() {
      protectorDisplay.textContent = state.protectorValue;
    }

    /* helper: show error */
    function showError() {
      errorBadge.classList.add('show');
      playSound(assets.error, 0.6);
      setTimeout(() => errorBadge.classList.remove('show'), 700);
    }

    /* helper: update stage tick UI */
    function setStageDone(n) {
      const el = document.querySelector(`.stage[data-stage="${n}"]`);
      if(el) el.classList.add('done');
    }

    /* set LED */
    function setLED(id, stateVal) {
      state.signals[id] = stateVal ? 'on' : 'off';
      const el = (id === 'LED3')? LED3 : (id === 'LED4')? LED4 : LED1;
      el.dataset.state = stateVal ? 'on' : 'off';
    }

    /* update game timer display */
    function formatTime(sec) {
      const mm = String(Math.floor(sec/60)).padStart(2,'0');
      const ss = String(sec%60).padStart(2,'0');
      return `${mm}:${ss}`;
    }
    
    function updateGameTimerDisplay() { 
      gameTimerEl.textContent = formatTime(state.gameTimerSec); 
    }

   /* start game timer  */
 
function startGameTimer() {
    if(state.gameRunning) return;
    state.gameRunning = true;
    updateGameTimerDisplay();
    state.gameTimerInterval = setInterval(() => {
        state.gameTimerSec--;
        updateGameTimerDisplay();
        if(state.gameTimerSec <= 0) {
            clearInterval(state.gameTimerInterval);
            state.gameRunning = false;
            
            // Ø±ÙˆØ´Ù† Ú©Ø±Ø¯Ù† Ú†Ø±Ø§Øº Ø¨ÛŒØ²Ø±
            const buzzerLight = document.getElementById('buzzerLight');
            buzzerLight.classList.add('blinking');
            
            // Ù¾Ø®Ø´ ØµØ¯Ø§ÛŒ Ø¨ÛŒØ²Ø± (Ø§Ú¯Ø± ÙØ§ÛŒÙ„ ØµÙˆØªÛŒ Ø¯Ø§Ø±ÛŒ)
            // playSound('assets/buzzer.mp3', 0.7);
            
            // ØªØ£Ø®ÛŒØ± Ù‚Ø¨Ù„ Ø§Ø² Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…
            setTimeout(() => {
                showError();
                alert('Ø²Ù…Ø§Ù† Ø¨Ø§Ø²ÛŒ Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯ â€” Ø´Ú©Ø³Øª.');
                window.location.reload();
            }, 2000); // 2 Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø¹Ø¯ Ø§Ø² Ø±ÙˆØ´Ù† Ø´Ø¯Ù† Ú†Ø±Ø§Øº
            
        }
    }, 1000);
  }

    /* protector modal open/close */
    function openProtectorModal() {
      protectorModal.classList.add('open');
      protectorModal.setAttribute('aria-hidden','false');
      state.protectorActive = true;
      protectorValueEl.textContent = 'S' + state.protectorValue;
      playSound(assets.click, 0.25);
    }
    
    function closeProtectorModal() {
      protectorModal.classList.remove('open');
      protectorModal.setAttribute('aria-hidden','true');
      state.protectorActive = false;
      // Ø¢Ù¾Ø¯ÛŒØª Ù†Ù…Ø§ÛŒØ´ Ø±ÙˆÛŒ Ù¾Ù†Ù„ Ø¨Ø¹Ø¯ Ø§Ø² Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„
      updateProtectorDisplayOnPanel();
    }

    /* Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø§ÛŒÙ†ØªØ±ÙˆØ§Ù„ Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ† Ø¯Ú©Ù…Ù‡ */
    let protUpInterval, protDownInterval;

    /* Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ† Ø¨Ø±Ø§ÛŒ Ø§ÙØ²Ø§ÛŒØ´ Ø³Ø±ÛŒØ¹ */
    protUp.addEventListener('mousedown', startIncrement);
    protUp.addEventListener('touchstart', startIncrement);
    protUp.addEventListener('mouseup', stopIncrement);
    protUp.addEventListener('touchend', stopIncrement);
    protUp.addEventListener('mouseleave', stopIncrement);

    /* Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ† Ø¨Ø±Ø§ÛŒ Ú©Ø§Ù‡Ø´ Ø³Ø±ÛŒØ¹ */
    protDown.addEventListener('mousedown', startDecrement);
    protDown.addEventListener('touchstart', startDecrement);
    protDown.addEventListener('mouseup', stopIncrement);
    protDown.addEventListener('touchend', stopIncrement);
    protDown.addEventListener('mouseleave', stopIncrement);

    /* Ø´Ø±ÙˆØ¹ Ø§ÙØ²Ø§ÛŒØ´ Ø¨Ø§ Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ† */
    function startIncrement() {
      playSound(assets.click, 0.2);
      incrementProtector();
      protUpInterval = setInterval(incrementProtector, 30);
    }

    /* Ø´Ø±ÙˆØ¹ Ú©Ø§Ù‡Ø´ Ø¨Ø§ Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ† */
    function startDecrement() {
      playSound(assets.click, 0.2);
      decrementProtector();
      protDownInterval = setInterval(decrementProtector, 30);
    }

    /* ØªÙˆÙ‚Ù Ø§ÛŒÙ†ØªØ±ÙˆØ§Ù„ */
    function stopIncrement() {
      clearInterval(protUpInterval);
      clearInterval(protDownInterval);
    }

    /* Ø§ÙØ²Ø§ÛŒØ´ Ù…Ù‚Ø¯Ø§Ø± Ù…Ø­Ø§ÙØ¸ */
    function incrementProtector() {
      state.protectorValue++;
      if(state.protectorValue > 500) state.protectorValue = 1;
      updateProtectorModalDisplay();
    }

    /* Ú©Ø§Ù‡Ø´ Ù…Ù‚Ø¯Ø§Ø± Ù…Ø­Ø§ÙØ¸ */
    function decrementProtector() {
      state.protectorValue = Math.max(1, state.protectorValue - 1);
      updateProtectorModalDisplay();
    }

    /* Ø¢Ù¾Ø¯ÛŒØª Ù†Ù…Ø§ÛŒØ´ Ù…Ù‚Ø¯Ø§Ø± Ø¯Ø± Ù…ÙˆØ¯Ø§Ù„ */
    function updateProtectorModalDisplay() {
      protectorValueEl.textContent = 'S' + state.protectorValue;
      protectorValueEl.classList.add('changing');
      setTimeout(() => {
        protectorValueEl.classList.remove('changing');
      }, 100);
    }

    /* Ú©Ù„ÛŒÚ© Ù…Ø¹Ù…ÙˆÙ„ÛŒ Ù‡Ù… Ú©Ø§Ø± Ú©Ù†Ù‡ */
    protUp.addEventListener('click', incrementProtector);
    protDown.addEventListener('click', decrementProtector);

    /* SET behavior - ØªÙ†Ø¸ÛŒÙ… Ø±ÙˆÛŒ 1 Ø«Ø§Ù†ÛŒÙ‡ */
    protSet.addEventListener('click', () => {
      playSound(assets.click, 0.3);
      if(state.protectorValue === 1 && state.stage === 2 && state.signals.LED4 === 'on') {
        // Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² - Ù…Ø­Ø§ÙØ¸ Ø±ÙˆÛŒ 1 Ø«Ø§Ù†ÛŒÙ‡ ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯
        setTimeout(() => {
          setLED('LED4', false);
          setLED('LED3', true);
          state.stage = 3;
          setStageDone(3);
          closeProtectorModal();
        }, 1000);
      } else {
        closeProtectorModal();
      }
    });

    /* close modal */
    protClose.addEventListener('click', closeProtectorModal);
    modalBackdrop.addEventListener('click', closeProtectorModal);
    mapBackdrop && mapBackdrop.addEventListener('click', () => mapModal.classList.remove('open'));

    /* protectorArea click */
    protectorArea.addEventListener('click', () => {
      openProtectorModal();
    });

    /* map click toggle */
    mapSmall.addEventListener('click', () => {
      mapModal.classList.add('open');
      mapModal.setAttribute('aria-hidden','false');
    });
    mapModal.addEventListener('click', () => mapModal.classList.remove('open'));
// Ø¹Ù†Ø§ØµØ± Ø¬Ø¯ÛŒØ¯
const mapLarge = $('.map-large');

/* Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù†Ù‚Ø´Ù‡ */
mapSmall.addEventListener('click', () => {
  mapModal.classList.add('open');
  document.body.style.overflow = 'hidden'; // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø³Ú©Ø±ÙˆÙ„
});

/* Ø¨Ø³ØªÙ† Ù†Ù‚Ø´Ù‡ */
function closeMapModal() {
  mapModal.classList.remove('open');
  document.body.style.overflow = ''; // Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Ú©Ø±ÙˆÙ„
}

// Ø¨Ø³ØªÙ† Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ backdrop
mapBackdrop.addEventListener('click', closeMapModal);

// Ø¨Ø³ØªÙ† Ø¨Ø§ Ú©Ù„ÛŒØ¯ ESC
document.addEventListener('keydown', (e) => {
  if(e.key === 'Escape' && mapModal.classList.contains('open')) {
    closeMapModal();
  }
});

// Ø¨Ø³ØªÙ† Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø®ÙˆØ¯ Ù†Ù‚Ø´Ù‡ Ø¨Ø²Ø±Ú¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
mapLarge.addEventListener('click', (e) => {
  e.stopPropagation(); // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¨Ø³ØªÙ† Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø®ÙˆØ¯ Ø¹Ú©Ø³
});
    /* S0 mushroom - start game */
   /* Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ - LED Ù‚Ø±Ù…Ø² Ø±ÙˆØ´Ù† */
$('#S0').addEventListener('click', () => {
  playSound(assets.click, 0.3);
    if(state.stage === 0) {
        state.stage = 1;
        setLED('LED3', true);  // Ù‚Ø±Ù…Ø² Ø±ÙˆØ´Ù†
        setLED('LED1', false); // Ø³Ø¨Ø² Ø®Ø§Ù…ÙˆØ´
        setStageDone(1);
        startGameTimer();
    }
});

/* Ù…Ø±Ø­Ù„Ù‡ 2 - LED Ø²Ø±Ø¯ Ø±ÙˆØ´Ù†ØŒ Ù‚Ø±Ù…Ø² Ø®Ø§Ù…ÙˆØ´ */
function checkStageProgress(kind, id) {
    if(state.stage === 1) {
        if(kind === 'push' && id === 'S1') {
            if(state.selector.S2 && state.selector.S2 !== 'left') {
                setLED('LED4', true);  // Ø²Ø±Ø¯ Ø±ÙˆØ´Ù†
                setLED('LED3', false); // Ù‚Ø±Ù…Ø² Ø®Ø§Ù…ÙˆØ´
                setLED('LED1', false); // Ø³Ø¨Ø² Ø®Ø§Ù…ÙˆØ´
                state.stage = 2;
                setStageDone(2);
                state.protectorValue = 300;
                updateProtectorDisplay();
            } else {
                showError();
                animateShake(document.getElementById('S1'));
            }
        }
    }
}

/* Ù…Ø±Ø­Ù„Ù‡ 3 - LED Ø³Ø¨Ø² Ø±ÙˆØ´Ù†ØŒ Ø²Ø±Ø¯ Ø®Ø§Ù…ÙˆØ´ */
protSet.addEventListener('click', () => {
    if(state.protectorValue === 1 && state.stage === 2 && state.signals.LED4 === 'on') {
        setTimeout(() => {
            setLED('LED4', false); // Ø²Ø±Ø¯ Ø®Ø§Ù…ÙˆØ´
            setLED('LED1', true);  // Ø³Ø¨Ø² Ø±ÙˆØ´Ù†
            state.stage = 3;
            setStageDone(3);
            closeProtectorModal();
        }, 1000);
    } else {
        closeProtectorModal();
    }
});

    /* selectors toggle left/right */
    ['S2','S3','S5'].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('click', () => {
        playSound(assets.click, 0.2);
        const next = (el.dataset.pos === 'left') ? 'right' : 'left';
        el.dataset.pos = next;
        state.selector[id] = next;
        el.setAttribute('aria-checked', next === 'right' ? 'true':'false');
        checkStageProgress('selector', id);
      });
    });

    /* joystick toggle neutral/down */
    $('#S9').addEventListener('click', () => {
      playSound(assets.click, 0.2);
      const el = $('#S9');
      el.dataset.pos = (el.dataset.pos === 'neutral') ? 'down' : 'neutral';
      state.joystick = el.dataset.pos;
      checkStageProgress('joystick');
    });

    /* push buttons behavior - Ø®ÙˆØ¯Ø¨Ø§Ø²Ú¯Ø´Øª */
    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ Ù„ÛŒØ³Øª Ù¾ÙˆØ´ Ø¨Ø§ØªÙ†â€ŒÙ‡Ø§
['S1','S4_START','S4_STOP','S6_START','S6_STOP','S7','S8','S10'].forEach(id => {
  const el = document.getElementById(id);
  el.addEventListener('click', () => {
    playSound(assets.click, 0.2);
    const now = Date.now();
    
    // ÙØ´Ø§Ø± Ø¯Ø§Ø¯Ù† Ù…ÙˆÙ‚Øª
    el.setAttribute('aria-pressed', 'true');
    state.pushes[id] = true;
    state.lastPressTimestamps[id] = now;
    
    // Ø¨Ø§Ø²Ú¯Ø´Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ø² 300ms
    setTimeout(() => {
      el.setAttribute('aria-pressed', 'false');
      state.pushes[id] = false;
    }, 200);
    
    checkStageProgress('push', id);
  });
});

// Ø¢Ù¾Ø¯ÛŒØª Ù…Ù†Ø·Ù‚ ÙÙ†â€ŒÙ‡Ø§
function checkStageProgress(kind, id) {
  // ... Ú©Ø¯Ù‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
  
  // stage 4: Ø±ÙˆØ´Ù† Ú©Ø±Ø¯Ù† ÙÙ† Ø¢Ø¨ÛŒ Ø¨Ø§ S6_START + S7
  if(state.stage === 3 || state.stage === 4) {
    if(kind === 'push' && (id === 'S6_START' || id === 'S7')) {
      if(isSimultaneous('S6_START','S7')) {
        if(state.stage >= 3) {
          setFan('blue', true);
          setStageDone(4);
          state.stage = 4;
        }  
        else {
          showError(); 
          animateShake(document.getElementById(id));
        }
      }
    }
  }

  // stage 5: Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù† ÙÙ† Ø¢Ø¨ÛŒ Ø¨Ø§ S6_STOP Ø³Ù¾Ø³ Ø±ÙˆØ´Ù† Ú©Ø±Ø¯Ù† ÙÙ† Ø²Ø±Ø¯ Ø¨Ø§ S4_START + S8
  if(state.stage >= 4 && state.stage < 6) {
    if(kind === 'push' && id === 'S6_STOP' && state.fan.blue) {
      setFan('blue', false);
    }
    if(kind === 'push' && (id === 'S4_START' || id === 'S8')) {
      if(isSimultaneous('S4_START','S8')) {
        if(!state.fan.blue) {
          setFan('yellow', true);
          setStageDone(5);
          state.stage = 5;
        } else {
          showError();
        }
      }
    }
  }

  // stage 6: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙÙ† Ø¢Ø¨ÛŒ Ø¯Ø± Ø­ÛŒÙ† Ú©Ø§Ø± ÙÙ† Ø²Ø±Ø¯
  if(state.stage === 5) {
    if(state.selector.S3 && state.selector.S5 && state.selector.S3 !== 'left' && state.selector.S5 !== 'left') {
      if(isSimultaneous('S6_START','S7')) {
        if(state.fan.yellow) {
          if(!state._stage6Step1) state._stage6Step1 = true;
        }
      }
      if(state._stage6Step1 && isSimultaneous('S4_START','S8')) {
        setFan('blue', true);
        setStageDone(6);
        state.stage = 6;
        state._stage6Step1 = false;
      }
    }
  }
}

    /* fan control helper: simultaneous detection within 700ms */
    function isSimultaneous(idA, idB) {
      const tA = state.lastPressTimestamps[idA] || 0;
      const tB = state.lastPressTimestamps[idB] || 0;
      return Math.abs(tA - tB) <= 1500;
    }

    /* fan on/off visual */
    function setFan(name, on) {
      if(name === 'blue') {
        state.fan.blue = on;
        if(on) { 
          fanBladeBlue.style.opacity = '1';
          fanBladeBlue.classList.add('rotate-medium');
        } else { 
          fanBladeBlue.style.opacity = '0';
          fanBladeBlue.classList.remove('rotate-medium');
        }
      } else {
        state.fan.yellow = on;
        if(on) { 
          fanBladeYellow.style.opacity = '1';
          fanBladeYellow.classList.add('rotate-medium');
        } else { 
          fanBladeYellow.style.opacity = '0';
          fanBladeYellow.classList.remove('rotate-medium');
        }
      }
    }

    /* check stage progression */
    function checkStageProgress(kind, id) {
      if(state.stage === 1) {
        if(kind === 'selector' && id === 'S2') {
          // nothing immediate
        }
        if(kind === 'push' && id === 'S1') {
          if(state.selector.S2 && state.selector.S2 !== 'left') {
            setLED('LED4', true);
            setLED('LED3', false);
            state.stage = 2;
            setStageDone(2);
            state.protectorValue = 300;
            updateProtectorDisplayOnPanel();
          } else {
            showError();
            animateShake(document.getElementById('S1'));
          }
        }
      } else if(state.stage === 2) {
        // waiting for protector
      } else if(state.stage === 3 || state.stage === 4) {
        if(kind === 'push' && (id === 'S6_START' || id === 'S7')) {
          if(isSimultaneous('S6_START','S7')) {
            if(state.stage >= 3) {
              setFan('blue', true);
              setStageDone(4);
              state.stage = 4;
            } else {
              showError(); 
              animateShake(document.getElementById(id));
            }
          }
        }
      }

      // stage 5
      if(state.stage >= 4 && state.stage < 6) {
        if(kind === 'push' && id === 'S6_STOP' && state.fan.blue) {
          setFan('blue', false);
        }
        
        if(kind === 'push' && (id === 'S4_START' || id === 'S8')) {
          if(isSimultaneous('S4_START','S8')) {
            if(!state.fan.blue) {
              setFan('yellow', true);
              playSound(assets.fan, 0.35, true);
              setStageDone(5);
              state.stage = 5;
            } else {
              showError();
            }
          }
        }
      }

     // stage 6: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙÙ† Ø¢Ø¨ÛŒ Ø¯Ø± Ø­ÛŒÙ† Ú©Ø§Ø± ÙÙ† Ø²Ø±Ø¯
if(state.stage === 5) {
  // Ø´Ø±Ø·: Ø³Ù„Ú©ØªÙˆØ±Ù‡Ø§ Ú†Ø±Ø®ÛŒØ¯Ù‡ + ÙÙ† Ø²Ø±Ø¯ Ø±ÙˆØ´Ù†
  const selectorsRotated = state.selector.S3 !== 'left' && state.selector.S5 !== 'left';
  const yellowFanOn = state.fan.yellow;
  
  if(selectorsRotated && yellowFanOn) {
    // Ù…Ù†ØªØ¸Ø± S6_START + S7 Ø¨Ø§Ø´
    if(kind === 'push' && (id === 'S6_START' || id === 'S7')) {
      if(isSimultaneous('S6_START','S7')) {
        // Ø¨Ø¹Ø¯ Ø§Ø² S6_START + S7ØŒ ÙÙ† Ø¢Ø¨ÛŒ Ø±Ùˆ Ø±ÙˆØ´Ù† Ú©Ù†
        setFan('blue', true);
        playSound(assets.fan, 0.35, true);
        setStageDone(6);
        state.stage = 6;
        console.log('âœ… stage 6 Ú©Ø§Ù…Ù„ Ø´Ø¯ - ÙÙ† Ø¢Ø¨ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
      }
    }
  }
}
      // stage 7
      if(state.stage === 6) {
        if(state.fan.blue && state.fan.yellow) {
          if(kind === 'joystick' && state.joystick === 'down') {
            // waiting for S10
          }
          if(kind === 'push' && id === 'S10') {
            if(state.joystick === 'down') {
              setStageDone(7);
              state.stage = 7;
              winLight.classList.add('on');
              alert('ØªØ¨Ø±ÛŒÚ©! Ø¨Ø§Ø²ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.');
            } else {
              showError(); 
              animateShake(document.getElementById('S10'));
            }
          }
        }
      }
    }

    /* small shake animation for wrong press */
    function animateShake(el) {
      if(!el) return;
      el.animate([
        { transform: 'translateX(0)' },
        { transform: 'translateX(-6px)' },
        { transform: 'translateX(6px)' },
        { transform: 'translateX(-4px)' },
        { transform: 'translateX(0)' }
      ], { duration: 360, iterations: 1 });
    }

// ÛŒØ§ Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø¯Ø³ØªÛŒØŒ Ø§ÛŒÙ† Ø±Ùˆ Ø¯Ø± Ú©Ù†Ø³ÙˆÙ„ Ø§Ø¬Ø±Ø§ Ú©Ù†:
// document.getElementById('winLight').classList.add('on')

    /* init */
    document.addEventListener('keydown', (e) => {
      if(e.key === 'Enter' || e.key === ' ') {
        const active = document.activeElement;
        if(active && active.click) active.click();
      }
    });

    // Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡ Ù…Ø­Ø§ÙØ¸
    updateProtectorDisplayOnPanel();
  </script>
</body>

</html>
